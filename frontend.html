<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' rel='stylesheet'
        integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC' crossorigin='anonymous'>

    <!-- Vue 3 -->
    <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.js'></script>
    <!-- Vue 3: production version, optimized for size and speed -->
    <!-- <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.prod.js'></script> -->
    <style>
        #carpark-container {
            overflow-y: auto;
            height: 500px;
        }
        #map {
            height: 100vh;
            width: calc(100% - 300px); /* Adjust width based on sidebar */
            float: right; /* Align to the right */
        }

        #sidebar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 500px;
            height: 100vh; 
            background-color: lightblue;
            overflow-y: scroll;
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Arrange children in a column */
        }

/* *************** START OF CSS FOR FAVOURITES **************** */

        /* Add styles for the fixed heading */
        #fixed-Favcontent {
            position: sticky;
            top: 0; /* Stick the content to the top */
            z-index: 1; /* Ensure it's above the scrolling content */
            background-color: lightblue; /* Match the background color of the container */
            padding: 0px; /* Add padding to the heading for better visibility */
        }

        /* Add styles for the scrolling content */
        #scrolling-content {
            padding-top: 0px; /* Ensure scrolling content starts below the fixed heading */
        }
        #favourites-container {
            /* ...existing styles... */
            overflow-y: auto; /* Enable vertical scrolling */;
            max-height: 260px;
            position: relative;
        }
        /* Style for the divider line */
        .divider {
            border-top: 1px solid black; /* Horizontal line */
            margin: 10px 0; /* Add some space above and below the line */
        }
        .carpark-title {
            font-size: 20px; /* Adjust the font size as needed */
            font-weight: bold; /* Optionally, make the text bold */
        }
        /* Define a class to target the table font size */
        .carpark-table {
            font-size: 15px; /* Adjust the font size as needed */
        }
        .carpark-info {
            max-width: 600px; /* Adjust the maximum width as needed */
            margin: 0 auto; /* Center the div horizontally */
            padding: 0px; /* Add padding to the div */
            margin-bottom: 0px;
        }
        .carpark-table th,
        .carpark-table td {
            border: 1px solid black; /* Add border to table cells */
            padding: 8px; /* Add padding for better spacing */
        }
        .carpark-table {
            margin-bottom: 20px; /* Adjust the margin as needed */
        }
/* *************** END OF CSS FOR FAVOURITES **************** */

    </style>
</head>
<body>
    <div id="sidebar">
        <div id="app" class="container">
            <h1>Carpark Information</h1>
            <div id="carpark-container">
                <!-- Carpark data will be displayed here -->
                <input type="text" id="searchQuery" placeholder="Enter location">
                <button id="searchBtn">Search</button>
                <ul id="carparksList"></ul>
            </div>
            <div class="divider"></div> <!-- Divider line -->
            <div id="favourites-container">
                <!-- Favourites will be displayed here -->
            </div>
        </div>
    </div>

    <div id="map"></div>


    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            const username = params.get('username');

            if (username) {
                console.log('Logged in as:', username);
                fetchFavourites(username);
                // Rest of your code...
            } else {
                // Redirect to the login page if no username is provided
                window.location.href = 'login.html';
            }
        });

///////////////////////////////////////////////////////// START OF CARPARK /////////////////////////////////////////////////////////

        function getCarParkData() {
            // Fetch car park data from getcarpark.py
            fetch('http://localhost:4002/data')
                .then(response => response.json())
                .then(data => {
                    // Update carparks with the new data
                    displayCarParkData(data);
                })
                .catch(error => {
                    console.error('Error fetching car park data:', error);
                });
        }

        function displayCarParkData(carparks) {
            var carparksList = document.getElementById('carparksList');
            carparksList.innerHTML = ''; // Clear existing content
            
            carparks.forEach(carpark => {
                var listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div>Name: ${carpark.ppName}</div>
                    <div>Code: ${carpark.ppCode}</div>
                    <div>Coordinates: ${carpark.coordinates}</div>
                    <div>Distance: ${carpark.distance.toFixed(3)} km</div>
                    ${carpark.lotType ? `<div>Lot Type: ${carpark.lotType}</div>` : ''}
                    ${carpark.lotsAvailable ? `<div>Lots Available: ${carpark.lotsAvailable}</div>` : ''}
                    <div>Capacity: ${carpark.parkCapacity}</div>
                    <div>Parking System: ${carpark.parkingSystem}</div>
                    <div>Weekday Rate: ${carpark.weekdayRate}</div>
                    <div>Saturday Rate: ${carpark.satdayRate}</div>
                    <div>Sunday & Public Holiday Rate: ${carpark.sunPHRate}</div>
                    <div>Operating Hours: ${carpark.startTime} - ${carpark.endTime}</div>
                `;
                carparksList.appendChild(listItem);
            });
        }
///////////////////////////////////////////////////////// END OF CARPARK /////////////////////////////////////////////////////////

///////////////////////////////////////////////////////// START OF FAVOURITES /////////////////////////////////////////////////////////
function fetchFavourites(username) {
            // Replace with the correct URL to fetch user favourites
            const url = `http://127.0.0.1:5002/users`;
            console.log('Fetch URL:', url);

            fetch(url)
                .then(response => {
                    console.log('Response:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('DATA:', data);
                    console.log('Users:', data.data.users);
                    const userFavourites = data.data.users
                        .filter(user => user.username === username)
                        .map(user => user.favourite);
                    console.log('User favourites:', userFavourites);
                    displayFavourites(username, userFavourites); // Pass username to the displayFavourites function
                })
                .catch(error => console.error('Error fetching favourites:', error));
        }

        function displayFavourites(username, favourites) {
            const container = document.getElementById('favourites-container');
            container.innerHTML = ''; // Clear existing content

            if (!favourites || favourites.length === 0) {
                container.innerHTML = '<p>No favourites available.</p>';
                return;
            }
            // Create and append the fixed content
            const fixedContent = document.createElement('div');
            fixedContent.id = 'fixed-Favcontent'; // Set the ID to fixed-Favcontent
            const heading = document.createElement('h2');
            heading.textContent = `${username}'s Favorites`;
            fixedContent.appendChild(heading);
            const divider = document.createElement('div');
            divider.classList.add('divider');
            fixedContent.appendChild(divider);
            container.appendChild(fixedContent);

            // Create and append the scrolling content
            const scrollingContent = document.createElement('div');
            scrollingContent.id = 'scrolling-content';
            favourites.forEach(favourite => {
                // Your existing code to display favourites goes here
            });
            container.appendChild(scrollingContent);

            // Fetch data from the consolidated endpoint
            fetch('http://127.0.0.1:5001/consolidated')
                .then(response => response.json())
                .then(data => {
                    favourites.forEach(favourite => {
                        const carparkData = data[favourite];
                        if (carparkData) {
                            const div = document.createElement('div');
                            div.classList.add('carpark-info'); // Add a class for styling
                            div.innerHTML = `<h2 class="carpark-title">${favourite} ${carparkData.ppName}</h2>`;
                            Object.entries(carparkData.vehicles).forEach(([vehicleType, vehicleData]) => {
                                const table = document.createElement('table');
                                table.classList.add('carpark-table'); // Add the class to the table
                                table.innerHTML = `
                                    <thead>
                                        <tr>
                                            <th>${vehicleType}</th>
                                            <th>Weekday</th>
                                            <th>Saturday</th>
                                            <th>Sun/PH</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${vehicleData.pricing.endTime.map((endTime, i) => {
                                            const startTime = vehicleData.pricing.startTime[i];
                                            const weekdayRate = vehicleData.pricing.weekdayRate[i];
                                            const satdayRate = vehicleData.pricing.satdayRate[i];
                                            const sunPHRate = vehicleData.pricing.sunPHRate[i];
                                            const weekdayMin = vehicleData.pricing.weekdayMin[i];
                                            const satdayMin = vehicleData.pricing.satdayMin[i];
                                            const sunPHMin = vehicleData.pricing.sunPHMin[i];
                                            if (weekdayRate !== "$0.00" || satdayRate !== "$0.00" || sunPHRate !== "$0.00") {
                                                return `
                                                    <tr>
                                                        <td>${startTime} - ${endTime}</td>
                                                        <td>${weekdayRate}/${weekdayMin}</td>
                                                        <td>${satdayRate}/${satdayMin}</td>
                                                        <td>${sunPHRate}/${sunPHMin}</td>
                                                    </tr>
                                                `;
                                            }
                                            return '';
                                        }).join('')}
                                    </tbody>
                                `;
                                div.appendChild(table);
                            });
                            container.appendChild(div);
                        }
                    });
                })
                .catch(error => console.error('Error fetching consolidated data:', error));
        }
///////////////////////////////////////////////////////// END OF FAVOURITES /////////////////////////////////////////////////////////

        


    </script>


    <!-- Bootstrap Javascript -->
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
        integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
        crossorigin='anonymous'></script>
</body>

</html>