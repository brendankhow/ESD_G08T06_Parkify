<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' rel='stylesheet'
        integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC' crossorigin='anonymous'>

    <!-- Vue 3 -->
    <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.js'></script>
    <!-- Vue 3: production version, optimized for size and speed -->
    <!-- <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.prod.js'></script> -->
    <style>
        #map {
            height: 100vh;
            width: calc(100% - 300px); /* Adjust width based on sidebar */
            float: right; /* Align to the right */
        }

        #sidebar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 300px;
            height: 100%;
            background-color: lightblue;
            overflow-y: scroll;
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Arrange children in a column */
        }

        /* Style for the divider line */
        .divider {
            border-top: 1px solid black; /* Horizontal line */
            margin: 10px 0; /* Add some space above and below the line */
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="app" class="container">
            <h1>Carpark Information</h1>
            <div id="carpark-container">
                <!-- Carpark data will be displayed here -->
                <input type="text" id="searchQuery" placeholder="Enter location">
                <button id="searchBtn">Search</button>
                <ul id="carparksList"></ul>
            </div>
            <div class="divider"></div> <!-- Divider line -->
            <div id="favourites-container">
                <!-- Favourites will be displayed here -->
            </div>
        </div>
    </div>

    <div id="map"></div>


    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            const username = params.get('username');

            if (username) {
                console.log('Logged in as:', username);
                fetchFavourites(username);
                // Rest of your code...
            } else {
                // Redirect to the login page if no username is provided
                window.location.href = 'login.html';
            }
        });

        function fetchFavourites(username) {
            // Replace with the correct URL to fetch user favourites
            const url = `http://127.0.0.1:5002/users`;
            console.log('Fetch URL:', url);

            fetch(url)
                .then(response => {
                    console.log('Response:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('DATA:', data);
                    console.log('Users:', data.data.users);
                    const userFavourites = data.data.users
                        .filter(user => user.username === username)
                        .map(user => user.favourite);
                    console.log('User favourites:', userFavourites);
                    displayFavourites(userFavourites);
                })
                .catch(error => console.error('Error fetching favourites:', error));
        }

        function displayFavourites(favourites) {
            const container = document.getElementById('favourites-container');
            container.innerHTML = ''; // Clear existing content

            if (!favourites || favourites.length === 0) {
                container.innerHTML = '<p>No favourites available.</p>';
                return;
            }

            // If favourites is an array, create a list of items
            const list = document.createElement('ul');
            favourites.forEach(favourite => {
                const item = document.createElement('li');
                item.textContent = favourite;
                item.style.color = 'black'; // Set text color to black
                list.appendChild(item);
            });
            container.appendChild(list);
        }



        function fetchUserData() {
            fetch('http://127.0.0.1:5002/users')
                .then(response => response.json())
                .then(data => {
                    displayUserData(data.data.users);
                })
                .catch(error => console.error('Error fetching user data:', error));
        }

        function displayUserData(users) {
            const container = document.getElementById('carpark-container');
            container.innerHTML = ''; // Clear existing content

            if (!users || users.length === 0) {
                container.innerHTML = '<p>No user data available.</p>';
                return;
            }

            const list = document.createElement('ul');
            users.forEach(user => {
                const item = document.createElement('li');
                item.textContent = `Username: ${user.username}, Email: ${user.email}, Favourite: ${user.favourite}`;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function fetchCarparkData() {
            fetch('http://127.0.0.1:5001/carparks/getAll') // Ensure this URL matches your Flask app's URL and port
                .then(response => response.json())
                .then(data => {
                    displayCarparkData(data.data.carparks);
                })
                .catch(error => console.error('Error fetching carpark data:', error));
        }

        function displayCarparkData(carparks) {
            const container = document.getElementById('carpark-container');
            container.innerHTML = ''; // Clear existing content

            if (!carparks || carparks.length === 0) {
                container.innerHTML = '<p>No carpark data available.</p>';
                return;
            }

            const list = document.createElement('ul');
            carparks.forEach(carpark => {
                const item = document.createElement('li');
                item.textContent = `Carpark No: ${carpark.carparkNo}, Coordinates: ${carpark.coordinates}, Lots Available: ${carpark.lotsAvailable}, Lot Type: ${carpark.lotType}`;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function clearData() {
            document.getElementById('carpark-container').innerHTML = '';
        }
        // JavaScript code to handle search functionality
        document.getElementById('searchBtn').addEventListener('click', function() {
            // Retrieve search query from input field
            var searchQuery = document.getElementById('searchQuery').value;
            
            // Send search query to backend to fetch geocode
            fetch(`http://localhost:3001/locations?location=${searchQuery}`)
                .then(response => response.json())
                .then(data => {
                    // Once coordinates are fetched, call the method to fetch car park data
                    getCarParkData();
                })
                .catch(error => {
                    console.error('Error fetching locations:', error);
                });
        });

        function getCarParkData() {
            // Fetch car park data from getcarpark.py
            fetch('http://localhost:4002/data')
                .then(response => response.json())
                .then(data => {
                    // Update carparks with the new data
                    displayCarParkData(data);
                })
                .catch(error => {
                    console.error('Error fetching car park data:', error);
                });
        }

        function displayCarParkData(carparks) {
            var carparksList = document.getElementById('carparksList');
            carparksList.innerHTML = ''; // Clear existing content
            
            carparks.forEach(carpark => {
                var listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div>Name: ${carpark.ppName}</div>
                    <div>Code: ${carpark.ppCode}</div>
                    <div>Coordinates: ${carpark.coordinates}</div>
                    <div>Distance: ${carpark.distance.toFixed(3)} km</div>
                    ${carpark.lotType ? `<div>Lot Type: ${carpark.lotType}</div>` : ''}
                    ${carpark.lotsAvailable ? `<div>Lots Available: ${carpark.lotsAvailable}</div>` : ''}
                    <div>Capacity: ${carpark.parkCapacity}</div>
                    <div>Parking System: ${carpark.parkingSystem}</div>
                    <div>Weekday Rate: ${carpark.weekdayRate}</div>
                    <div>Saturday Rate: ${carpark.satdayRate}</div>
                    <div>Sunday & Public Holiday Rate: ${carpark.sunPHRate}</div>
                    <div>Operating Hours: ${carpark.startTime} - ${carpark.endTime}</div>
                `;
                carparksList.appendChild(listItem);
            });
        }

    </script>


    <!-- Bootstrap Javascript -->
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
        integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
        crossorigin='anonymous'></script>
</body>

</html>