<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' rel='stylesheet'
        integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC' crossorigin='anonymous'>

    <!-- Vue 3 -->
    <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.js'></script>
    <!-- Vue 3: production version, optimized for size and speed -->
    <!-- <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.prod.js'></script> -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZWdlWHab5pByYWfhgQSxP83V2WatS3YU&callback=initMap"
        defer></script>
    <style>
        #map {
            height: 100vh;
            width: calc(100% - 300px);
            /* Adjust width based on sidebar */
            float: right;
            /* Align to the right */
        }

        #sidebar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 300px;
            height: 100%;
            background-color: lightblue;
            overflow-y: scroll;
            display: flex;
            /* Use flexbox for layout */
            flex-direction: column;
            /* Arrange children in a column */
        }

        /* Style for the divider line */
        .divider {
            border-top: 1px solid black;
            /* Horizontal line */
            margin: 10px 0;
            /* Add some space above and below the line */
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div id="app" class="container">
            <h1>Carpark Information</h1>
            <div id="carpark-container">
                <!-- Carpark data will be displayed here -->
                <input type="text" id="searchQuery" placeholder="Enter location">
                <button id="searchBtn">Search</button>
                <ul id="carparksList"></ul>
            </div>
            <div class="divider"></div> <!-- Divider line -->
            <div id="favourites-container">
                <!-- Favourites will be displayed here -->
            </div>
        </div>
    </div>

    <div id="map"></div>


    <script>
        //for map
        (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })({
            key: "AIzaSyCZWdlWHab5pByYWfhgQSxP83V2WatS3YU",
            v: "weekly",
            // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
            // Add other bootstrap parameters as needed, using camel case.
        });
        let map;
        let mainMarker;
        let additionalMarkers = [];



        function initMap(defaultPosition, additionalMarkers) {
            try {
                // Ensure google.maps is available
                if (!google || !google.maps) {
                    console.error('Google Maps API is not loaded.');
                    return;
                }

                console.log("Initializing map at position:", defaultPosition);

                // The map, centered at the extracted position
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 14,
                    center: defaultPosition,
                    mapId: "DEMO_MAP_ID",
                });

                console.log("Map initialized.");

                // Add a marker for the default position
                mainMarker = new google.maps.Marker({
                    position: defaultPosition,
                    map: map,
                    title: "Search Location" // Optional: Add a title to the marker
                });

                console.log("Default marker added to the map.");

                // Add additional markers
                if (additionalMarkers && additionalMarkers.length > 0) {
                    additionalMarkers.forEach(marker => {
                        new google.maps.Marker({
                            position: marker.position,
                            map: map,
                            title: marker.title,
                            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' // Green marker icon
                        });
                        console.log("Additional marker added to the map.");
                    });
                }

            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        document.getElementById('searchBtn').addEventListener('click', function () {
            // Retrieve search query from input field
            var searchQuery = document.getElementById('searchQuery').value;

            // Update the map with new position
            updateMapWithNewPosition(searchQuery);
        });

        async function updateMapWithNewPosition(searchQuery) {
            try {
                let position;

                if (searchQuery.trim() === '') {
                    // If search query is empty, set a default position
                    position = { lat: 1.2963, lng: 103.8502 }; // Default position
                } else {
                    // If search query is not empty, fetch location data
                    const response = await fetch(`http://localhost:3001/locations?location=${searchQuery}`);
                    const data = await response.json();
                    if (data.locations && data.locations.length > 0) {
                        const coordinates = data.locations[0].coordinates.split(',');
                        position = { lat: parseFloat(coordinates[0]), lng: parseFloat(coordinates[1]) };
                    } else {
                        console.error('No carpark locations found.');
                        return;
                    }
                }

                // Update main marker position
                mainMarker.setPosition(position);

                // Center the map to the new position
                map.setCenter(position);

                // Fetch new data from localhost:4002/data
                const newDataResponse = await fetch('http://localhost:4002/data');
                const newData = await newDataResponse.json();

                // Remove existing additional markers from the map
                additionalMarkers.forEach(marker => {
                    marker.setMap(null);
                });

                // Clear the existing array
                additionalMarkers = [];

                // Extract coordinates from the new data and create markers
                newData.forEach(item => {
                    const marker = new google.maps.Marker({
                        position: {
                            lat: parseFloat(item.coordinates.split(',')[0]),
                            lng: parseFloat(item.coordinates.split(',')[1])
                        },
                        map: map,
                        title: item.ppName, // Set marker title to ppName
                        icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' // Green marker icon
                    });
                    additionalMarkers.push(marker);
                });

            } catch (error) {
                console.error('Error updating map with new position:', error);
            }
        }

        // JavaScript code to handle search functionality
        document.getElementById('searchBtn').addEventListener('click', function () {
            // Retrieve search query from input field
            var searchQuery = document.getElementById('searchQuery').value;

            // Update the map with new position
            updateMapWithNewPosition(searchQuery);
        });
        // Fetch the data from localhost:4002/data
        fetch('http://localhost:4002/data')
            .then(response => response.json())
            .then(data => {
                // Extract coordinates from the data and create markers
                const additionalMarkers = data.map(item => ({
                    position: {
                        lat: parseFloat(item.coordinates.split(',')[0]),
                        lng: parseFloat(item.coordinates.split(',')[1])
                    },
                    title: item.ppName // Set marker title to ppName
                }));

                // Call initMap with default position and additional markers
                const defaultPosition = { lat: 1.2963, lng: 103.8502 }; // Set your default position
                initMap(defaultPosition, additionalMarkers);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });


        // Call initMap with default position and additional markers when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            const defaultPosition = { lat: 1.2963, lng: 103.8502 };
            initMap(defaultPosition, additionalMarkers);
        });


        function fetchFavourites(username) {
            // Replace with the correct URL to fetch user favourites
            const url = `http://127.0.0.1:5002/users`;
            console.log('Fetch URL:', url);

            fetch(url)
                .then(response => {
                    console.log('Response:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('DATA:', data);
                    console.log('Users:', data.data.users);
                    const userFavourites = data.data.users
                        .filter(user => user.username === username)
                        .map(user => user.favourite);
                    console.log('User favourites:', userFavourites);
                    displayFavourites(userFavourites);
                })
                .catch(error => console.error('Error fetching favourites:', error));
        }

        function displayFavourites(favourites) {
            const container = document.getElementById('favourites-container');
            container.innerHTML = ''; // Clear existing content

            if (!favourites || favourites.length === 0) {
                container.innerHTML = '<p>No favourites available.</p>';
                return;
            }

            // If favourites is an array, create a list of items
            const list = document.createElement('ul');
            favourites.forEach(favourite => {
                const item = document.createElement('li');
                item.textContent = favourite;
                item.style.color = 'black'; // Set text color to black
                list.appendChild(item);
            });
            container.appendChild(list);
        }



        function fetchUserData() {
            fetch('http://127.0.0.1:5002/users')
                .then(response => response.json())
                .then(data => {
                    displayUserData(data.data.users);
                })
                .catch(error => console.error('Error fetching user data:', error));
        }

        function displayUserData(users) {
            const container = document.getElementById('carpark-container');
            container.innerHTML = ''; // Clear existing content

            if (!users || users.length === 0) {
                container.innerHTML = '<p>No user data available.</p>';
                return;
            }

            const list = document.createElement('ul');
            users.forEach(user => {
                const item = document.createElement('li');
                item.textContent = `Username: ${user.username}, Email: ${user.email}, Favourite: ${user.favourite}`;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function fetchCarparkData() {
            fetch('http://127.0.0.1:5001/carparks/getAll') // Ensure this URL matches your Flask app's URL and port
                .then(response => response.json())
                .then(data => {
                    displayCarparkData(data.data.carparks);
                })
                .catch(error => console.error('Error fetching carpark data:', error));
        }

        function displayCarparkData(carparks) {
            const container = document.getElementById('carpark-container');
            container.innerHTML = ''; // Clear existing content

            if (!carparks || carparks.length === 0) {
                container.innerHTML = '<p>No carpark data available.</p>';
                return;
            }

            const list = document.createElement('ul');
            carparks.forEach(carpark => {
                const item = document.createElement('li');
                item.textContent = `Carpark No: ${carpark.carparkNo}, Coordinates: ${carpark.coordinates}, Lots Available: ${carpark.lotsAvailable}, Lot Type: ${carpark.lotType}`;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function clearData() {
            document.getElementById('carpark-container').innerHTML = '';
        }
        // JavaScript code to handle search functionality
        document.getElementById('searchBtn').addEventListener('click', function () {
            // Retrieve search query from input field
            var searchQuery = document.getElementById('searchQuery').value;

            // Send search query to backend to fetch geocode
            fetch(`http://localhost:3001/locations?location=${searchQuery}`)
                .then(response => response.json())
                .then(data => {
                    // Once coordinates are fetched, call the method to fetch car park data
                    getCarParkData();
                })
                .catch(error => {
                    console.error('Error fetching locations:', error);
                });
        });

        function getCarParkData() {
            // Fetch car park data from getcarpark.py
            fetch('http://localhost:4002/data')
                .then(response => response.json())
                .then(data => {
                    // Update carparks with the new data
                    displayCarParkData(data);
                })
                .catch(error => {
                    console.error('Error fetching car park data:', error);
                });
        }

        function displayCarParkData(carparks) {
            var carparksList = document.getElementById('carparksList');
            carparksList.innerHTML = ''; // Clear existing content

            carparks.forEach(carpark => {
                var listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div>Name: ${carpark.ppName}</div>
                    <div>Code: ${carpark.ppCode}</div>
                    <div>Coordinates: ${carpark.coordinates}</div>
                    <div>Distance: ${carpark.distance.toFixed(3)} km</div>
                    ${carpark.lotType ? `<div>Lot Type: ${carpark.lotType}</div>` : ''}
                    ${carpark.lotsAvailable ? `<div>Lots Available: ${carpark.lotsAvailable}</div>` : ''}
                    <div>Capacity: ${carpark.parkCapacity}</div>
                    <div>Parking System: ${carpark.parkingSystem}</div>
                    <div>Weekday Rate: ${carpark.weekdayRate}</div>
                    <div>Saturday Rate: ${carpark.satdayRate}</div>
                    <div>Sunday & Public Holiday Rate: ${carpark.sunPHRate}</div>
                    <div>Operating Hours: ${carpark.startTime} - ${carpark.endTime}</div>
                `;
                carparksList.appendChild(listItem);
            });
        }

    </script>


    <!-- Bootstrap Javascript -->
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
        integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
        crossorigin='anonymous'></script>
</body>

</html>